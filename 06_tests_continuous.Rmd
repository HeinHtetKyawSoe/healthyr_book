# (PART) Data analysis {-}

```{r include=FALSE}
theme_set(theme_bw())
```

In the second part of this book, we focus specifically on the business of data analysis.
That is, formulating clear questions and seeking to answer them using available datasets. 

Again, we emphasise the importance of understanding the underlying data through visualisation, rather than relying on statistical tests or, heaven forbid, the p-value alone. 

There are five chapters. 
Testing for continuous outcome variables (6) leads naturally into Linear regression (7). 
We would expect the majority of actual analysis done by readers to be using the methods in chpater 7 rather than 6. 
Similarly, Testing for categorical outcome variables (8) leads naturally to Logistic regression (9), where we would expect the majority of work to focus. 
Chapters 6 and 8 however do provide helpful reminders of how to prepare data for these analyses and shouldn't be skipped.
Time-to-event data introduces survival analysis and includes sections on the maniuplation of dates. 

# Tests for continuous outcome variables

> Continuous data can be measured.
> Categorical data can be counted.

## Continuous data

Continuous data is everywhere in healthcare. 
From physiolgical measures in patients such as systolic blood pressure or pulmonary function tests, through to populations meausres like life expectancy or disease incidence, the analysis of continuous outcome measures is common and important.

Our goal in most health data questions, is to draw a conclusion on a comparison between groups. 
For instance, understanding differences life expectancy between the year 2002 and 2007 or between the Africa and Europe, is usually more useful than simply describing the average life expectancy across the entire world across all of time. 

The basis for comparisons between continous measures is the distribution of the data. 
That word, as many which have a stastistical flavour, brings on the sweats in a lot of people. 
It needn't. 
By distribution, we are simply referring to the shape of the data. 

<!-- Probably: -->
<!-- Figure of histograms or density plots showing normal, skew, mean, median. -->
<!-- Do we need SD vs SEM? -->
<!-- Maybe shiny app to help with this like https://gallery.shinyapps.io/dist_calc/ -->

## The Question

The examples in this chapter all use the data introduced previously from the amazing [Gapminder project](https://www.gapminder.org/). 
We will start by looking at the life expectancy of populations over time and in different geographical regions. 

## Get the data

```{r, message=F}
# Load packages
library(tidyverse)
library(finalfit)
library(gapminder)
library(broom)

# Create object mydata from object gapminder
mydata = gapminder
```

## Check the data

It is vital that data is carefully inspected when first read. 
<!-- Ref preparing data chapter -->
The three functions below provide a clear summary allowing errors or miscoding to be quickly identified. 
It is parituclary important to ensure that any missing data is identified. 
If you don't do this you will regret it! 
There are many times when an analysis has got to a relatively advanced stage before researchs realised the dataset was incomplete. 

```{r}
glimpse(mydata)         # each variable on a single line, variable type, first values
missing_glimpse(mydata) # missing data for each variable
ff_glimpse(mydata)      # summary statistics for each variable
```

As can be seen, there are 6 variables, 4 are continuous and 2 are categorical. The categorical variables are already identiifed as `factors`. There are no missing data. 

## Plot the data

We will start by comparing life expectancy between the 5 continents of the world in two different years. 
Always plot your data first. 
Never skip this step!
We are particularly interested in the distribution. 
There's that word again. 
The shape of the data. 
Is it normal? 
Is it skewed? 
Does it differ between regions and years?

There are three useful plots which can help here: 

 - Histograms: examine shape of data and compare groups;
 - Q-Q plots: are data normally distributed?
 - Box-plots: identify outliers, compare shape and groups.

### Histogram for each continent

```{r, fig.width=7, fig.height=3.5}
mydata %>% 
	filter(year %in% c(2002, 2007)) %>%  # only 2002 and 2007
	ggplot(aes(x = lifeExp)) +           # x-axis is life expectancy
	geom_histogram(bins = 20) +          # histogram with data chopped into 20 bars
	facet_grid(year ~ continent)         # create grid of year by continent
                                       # add scale = "free" to facet_grid to allow axes to vary
```

What can we see? That life expectcy in Africa is lower than in other regions. That we have little data for Oceania given there are only two countries included, Australia and New Zealand. That Africa and Asia have great variability in life expectancy by country than in the Americas or Europe. That the data follow a reasonably normal shape, with Africa 2002 a little right skewed. 

### Q-Q plot for each continent

A quantile-quantile sounds complicated but is not. 
It is simply a graphical method for comparing the distribution (think shape) of our own data to a theoretical distribution, such as the normal distributuion. 
In this context, quantiles are just cut points which divide our data into bins each containing the same number of observations.
For example, if we have the life expectacny for 100 countries, then quartiles (note the quar-) for life expectancy are the three ages which split the observations into 4 groups each containing 25 countries. 
A Q-Q plot simply plots the quantiles for our data against the theorectical quantiles for a particular distributions (default below is normal). 
If our data follow that distribution (e.g. normal), then we get a 45 degree line on the plot. 

```{r, fig.width=7, fig.height=3.5}
mydata %>% 
  filter(year %in% c(2002, 2007)) %>% 
  ggplot(aes(sample = lifeExp)) + 
  geom_qq() +
  geom_qq_line() + 
  facet_grid(year ~c ontinent)
```

What can we see. We are looking to see if the data follow the 45 degree line which is included in the plot. These do reasonably, except for Africa which is curved upwards at each end, suggesting a skew. 

### Boxplot of 2 years

```{r, fig.width=7, fig.height=3}
mydata %>% 
  filter(year %in% c(2002, 2007)) %>% 
  ggplot(aes(x = factor(year), y = lifeExp)) + 
  geom_boxplot() + 
  facet_grid(. ~ continent)
```


# To here!


## T-test
A *t*-test is used to compare the means of two groups of continuous variables.


### Exercise
Make a histogram, Q-Q plot, and a box-plot for the life expectancy for a continent of your choice, but for all years. Does the data appear normally distributed?

## Two-sample *t*-tests

Lets perform a *t*-test on the "Americas" data as it appears normally distributed. 
We are savings the results of our *t*-test into a variable called t.result, but you can call it whatever you like (e.g. `myttest`).


```{r, fig.width=4, fig.height=4}

mydata %>% 
  filter(year %in% c(2002, 2007)) %>%
  filter(continent == "Americas") -> test.data

t.test(lifeExp~year, data=test.data)

mydata %>% 
  filter(year %in% c(2002, 2007)) %>%
  filter(continent == "Americas") %>% 
  t.test(lifeExp~year, data = .) -> t.result

t.result

```

### T-test output

However, that output isn't in a useful format, let's investigate the output of the function `t.test()`. 

```{r}

names(t.result)
str(t.result) # or click on the blue button in the Environment tab

```

The structure of R's `t.test()` result looks a bit overwhelming. 
Fortunately, the `tidy()` function from `library(broom)` puts it into a neat data frame for us:

```{r}

t.result <- tidy(t.result) # broom package puts it all in a data frame

```

Try clicking on it in the Environment tab.

Thus, now we understand the output structure we can extract any result.

```{r}

t.result$p.value

```


### Exercise

1. Select any 2 years in any continent and perform a *t*-test to determine whether the life expectancy is signficantly different. 
Remember to plot your data first.

2. Extract only the p-value from your `t.test()` output.


## One sample *t*-tests

However, we don't always want to compare 2 groups or sometimes we don't have the data to be able to.

Let's investigate whether the mean life expectancy in each continent significant different to 77 years in 2007.

```{r}

mydata %>% 
  filter(year==2007, continent=='Europe') -> subdata

# Standard one-sample t-test
t.test(subdata$lifeExp, mu=77)

```

### Exercise

1. Select a different year, different continent, and different age to compare with mean life expectancy.

2. Replace mu=77 with mu=0 (the default value). How does this affect your result?


## ANOVA

In some cases, we may also want to test more than two groups to see if they are signficantly different.

### Plotting

For example, lets plot the life expectancy in 2007 accross 3 continents.
```{r, fig.width=3, fig.height=3}

mydata %>% 
	filter(year == 2007) %>% 
	filter(continent %in% c("Americas", "Europe", "Asia")) %>% 
	ggplot(aes(x = continent, y=lifeExp)) +
	geom_boxplot()

```

### Analysis

ANOVA tests are useful for testing for the presence of signficant differences between more than two groups or variables.

```{r}

mydata %>% 
  filter(year == 2007) %>% 
  filter(continent %in% c("Americas", "Europe", "Asia")) -> subdata

fit = aov(lifeExp~continent, data = subdata) 

summary(fit)

mydata %>% 
  filter(year == 2007) %>% 
  filter(continent %in% c("Americas", "Europe", "Asia")) %>% 
  aov(lifeExp~continent, data = .) %>% 
	tidy()

```

### Check assumptions

```{r, fig.width=5, fig.height=5}

par(mfrow=c(2, 2)) # 4 plots in 2 x 2 grid
plot(fit)

```

### Perform pairwise tests

The ANOVA test was significant, indicating that there is a signficant difference in the mean life expectancy across those continents.

But which continents are significantly different, and can we quantify this difference as a *p*-value?

```{r}

mydata %>% 
  filter(year == 2007) %>% 
  filter(continent %in% c("Americas", "Europe", "Asia")) -> subdata

pairwise.t.test(subdata$lifeExp, subdata$continent)

# or equivalently, without saving the subset in a separate variable:
# sending it into the test using pipes only

mydata %>% 
  filter(year == 2007) %>% 
  filter(continent %in% c("Americas", "Europe", "Asia")) %>% 
  pairwise.t.test(.$lifeExp, .$continent, data=.) %>% 
  tidy()

```

F1 for help to see options for `pairwise.t.test()`.

### Top tip: the cut() function

A great way of easily converting a continuous variable to a categorical variable is to use the `cut()` function.

```{r}

pop_quantiles = quantile(mydata$pop)

mydata %>% 
	mutate(pop.factor = cut(pop, breaks=pop_quantiles)) -> mydata
```

### Exercise

When we used `cut()` to divide country populations into quantiles, the labels it assigned were not very neat:

```{r}

mydata$pop.factor %>% levels()

```

Use `fct_recode()` to change them to something nicer, e.g., "Tiny", "Small", "Medium", "Large":

```{r}

mydata$pop.factor %>% 
  fct_recode("Tiny"   = "(6e+04,2.79e+06]",
             "Small"  = "(2.79e+06,7.02e+06]",
             "Medium" = "(7.02e+06,1.96e+07]",
             "Large"  = "(1.96e+07,1.32e+09]") -> mydata$pop.factor 

```


### Exercise

Perform ANOVA to test for a difference in mean life expectancy by country population factor (`mydata$pop.factor`). Remember to plot data first

```{r, fig.width=4, fig.height=3}

mydata %>% 
	filter(year == 2007) %>% 
	ggplot(aes(x=pop.factor, y=lifeExp))+
	geom_boxplot()

mydata %>% 
	filter(year == 2007) %>% 
	aov(.$lifeExp ~ .$pop.factor, data=.) %>% 
	summary()

```


## Non-parametric data
If your data is not parametric (i.e. not normally distributed), then the usual *t*-test is invalid. In this case there are 2 options:

1. Non-parametric statistical tests.

2. "Transform" the data to fit a normal distribution (*not covered here*) so that a *t*-test can be used.

### Plotting

Lets plot the life expectancy within Africa in 1997, 2002, and 2007.

```{r, fig.width=3, fig.height=3}

# African data is not normally distributed
mydata %>% 
  filter(year %in% c(1997, 2002, 2007)) %>%
  filter(continent == "Africa") %>% 
  ggplot(aes(x = lifeExp)) +
  geom_histogram(bins = 10, fill=NA, colour='black') +
  facet_grid(year~continent)

mydata %>% 
  filter(year %in% c(1997, 2002, 2007)) %>%
  filter(continent == "Africa") %>% 
  group_by(year) %>% 
  summarise(avg = mean(lifeExp), med = median(lifeExp))

```


### Exercise: Non-parametric testing

Mann-Whitney U test is also called the Wilcoxon rank sum test (note the Wilcoxon signed rank test is for paried data).

Is there a significant increase in the life expectencies for African countries between 1992 and 2007? How about 1982 and 2007?

```{r, fig.width=3, fig.height=2}
mydata$year %>%  unique()

mydata %>% 
  filter(continent == "Africa") %>% 
  group_by(year) %>% 
  summarise(mean = mean(lifeExp), median = median(lifeExp)) %>% 
  ggplot(aes(x = year, y = median)) +
	  geom_line()

```


```{r, fig.width=4, fig.height=3}
mydata %>% 
  filter(continent == "Africa") %>% 
  ggplot(aes(x = factor(year), y=lifeExp)) + #demonstrate that needs to be factor(year), not year
  geom_boxplot()

mydata %>% 
  filter(year %in% c(1992, 2007)) %>%
  filter(continent == "Africa") %>% 
  wilcox.test(lifeExp~year, data=.)
```

## Solutions

**5.2.2**

```{r, fig.width=4, fig.height=4, eval = FALSE}

mydata %>% 
  filter(continent == "Europe") %>% 
  ggplot(aes(x = lifeExp)) + 
  geom_histogram() +
  facet_wrap(~year)

mydata %>% 
  filter(continent == "Europe") %>% 
  ggplot(aes(sample = lifeExp)) + 
  geom_point(stat = "qq") +
  facet_wrap(~year)

mydata %>% 
  filter(continent == "Europe") %>% 
  ggplot(aes(y = lifeExp, x = factor(year))) + 
  geom_boxplot()
  
```


## Advanced example
This is a complex but useful example which shows you the power of the syntax. Here multiple *t*-tests are performed and reported with just a few lines of code. 

Performing *t*-tests across all continents at once:

```{r, fig.width=6, fig.height=4}
mydata %>% 
  filter(year %in% c(1997, 2007)) %>% 
  group_by(continent) %>%
	do(
		tidy(
			t.test(lifeExp~year, data=.)
		)
	)
```
