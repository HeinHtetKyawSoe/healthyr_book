# Exporting and reporting{#chap12-h1}

In chapter \ref(chap11-h1) we emphasised one of the less well known strengths of R  - the ease with which reports can be written in HTML (web page), PDF, or Word documents. 


```{r echo=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
mykable = function(x, caption = "CAPTION", ...){
  kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"), 
        booktabs = TRUE, caption = caption, 
        linesep = c("", "", "\\addlinespace"), ...) %>%
    kable_styling(latex_options = c("scale_down", "hold_position"))
}
```

## The Question

What follows is for demonstration purposes and is not meant to illustrate model building. 
We will ask, does a particular characteristic of a colon cancer (differentiation) predict 5-year survival?


## Get the data

```{r message=FALSE}
library(tidyverse)
library(finalfit)
data(colon_s)
```

First explore variable of interest (exposure) by making it the dependent.

```{r, warning=FALSE, message=FALSE}
# Dependent variable
dependent = "differ.factor"

# Specify explanatory variables of interest
explanatory = c("age", "sex.factor", 
                "extent.factor", "obstruct.factor", 
                "nodes")
```

Note this useful alternative way of specifying explanatory variable lists:

```{r}
explanatory = colon_s %>% 
  select(age, sex.factor, extent.factor, obstruct.factor, nodes) %>% 
  names()
```

## Check the data

```{r, eval=FALSE}
colon_s %>% 
  ff_glimpse(dependent, explanatory)
```

## Demographics table

Look at associations between our exposure and other explanatory variables. 

```{r, eval=FALSE}
colon_s %>% 
  summary_factorlist(dependent, explanatory)
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
colon_s %>% 
  summary_factorlist(dependent, explanatory, 
                     p=TRUE, na_include=TRUE) %>% 
  mykable(caption = "Exporting 'table 1': Tumour differentiation by patient and disease factors.")
```

Note missing data in `obstruct.factor` (REF missing data). 

We will drop this variable for now. 
Also see that nodes has not been labelled. 
There are small numbers in some variables generating `chisq.test()` warnings (expected fewer than 5 in any cell). 
Generate final table.

```{r, eval=FALSE}
colon_s = colon_s %>% 
  mutate(
    nodes = ff_label(nodes, "Lymph nodes involved"))

explanatory = c("age", "sex.factor", 
                "extent.factor", "nodes")

table1 = colon_s %>% 
  summary_factorlist(dependent, explanatory, 
                     p=TRUE, na_include=TRUE, 
                     add_dependent_label=TRUE
                     )
table1
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
colon_s = colon_s %>% 
  mutate(
    nodes = ff_label(nodes, "Lymph nodes involved"))

explanatory = c("age", "sex.factor", 
                "extent.factor", "nodes")

colon_s %>% 
  summary_factorlist(dependent, explanatory, 
                     p=TRUE, na_include=TRUE, 
                     add_dependent_label=TRUE) %>% 
  mykable(caption = "Exporting 'table 1': adjusting labels and output.") %>% 
  column_spec(1, width = "3.5cm")
```

## Logistic regression table

Now examine explanatory variables against outcome. Check plot runs ok.

```{r, eval=FALSE}
explanatory = c("age", "sex.factor", 
                "extent.factor", "nodes", "differ.factor")
dependent = "mort_5yr"
table2 = colon_s %>% 
  finalfit(dependent, explanatory, 
           dependent_label_prefix = "")
table2
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
explanatory = c("age", "sex.factor", 
                "extent.factor", "nodes", "differ.factor")
dependent = "mort_5yr"
colon_s %>% 
  finalfit(dependent, explanatory, 
           dependent_label_prefix = "") %>% 
  mykable(caption = "Exporting a regression results table.")
```

## Odds ratio plot

```{r fig.height=3.5, fig.width=7, message=FALSE, warning=FALSE, fig.cap="Odds ratio plot."}
colon_s %>% 
  or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.5)
```

## MS Word via knitr/R Markdown

Important. 
In most R Markdown set-ups, environment objects require to be saved and loaded to R Markdown document.

```{r, eval=FALSE}
# Save objects for knitr/markdown
save(table1, table2, dependent, explanatory, file = "out.rda")
```

We use RStudio Server Pro set-up on Ubuntu. But these instructions should work fine for most/all RStudio/Markdown default set-ups.

In RStudio, select File > New File > R Markdown.

A useful template file is produced by default. Try hitting knit to Word on the knitr button at the top of the .Rmd script window.

Now paste this into the file:

```` markdown
---
title: "Example knitr/R Markdown document"
author: "Your name"
date: "22/5/2020"
output:
word_document: default
---

`r ''````{r setup, include=FALSE}
# Load data into global environment. 
library(finalfit)
library(dplyr)
library(knitr)
load("out.rda")
```

## Table 1 - Demographics
`r ''````{r table1, echo = FALSE}
kable(table1, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Table 2 - Association between tumour factors and 5 year mortality
`r ''````{r table2, echo = FALSE}
kable(table2, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Figure 1 - Association between tumour factors and 5 year mortality
`r ''````{r figure1, echo = FALSE}
colon_s %>% 
or_plot(dependent, explanatory)
```
````

[The result is ok, but not great.](https://www.datasurg.net/wp-content/uploads/2018/05/example.docx) 


## Create Word template file

Now, edit your Word file to create a new template. Click on a table. The style should be `compact`. Right click > Modify... > font size = 9. Alter heading and text styles in the same way as desired. Save this as `template.docx`. Upload the file to your project folder. Add this reference to the .Rmd YAML heading, as below. Make sure you get the spacing correct.

The plot also doesnâ€™t look quite right and it prints with warning messages. Experiment with fig.width to get it looking right.

Now paste this into your .Rmd file and run:

```` markdown
---
title: "Example knitr/R Markdown document"
author: "Ewen Harrison"
date: "21/5/2018"
output:
word_document:
reference_docx: template.docx  
---

`r ''````{r setup, include=FALSE}
# Load data into global environment. 
library(finalfit)
library(dplyr)
library(knitr)
load("out.rda")
```

## Table 1 - Demographics
`r ''````{r table1, echo = FALSE, results='asis'}
kable(table1, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Table 2 - Association between tumour factors and 5 year mortality
`r ''````{r table2, echo = FALSE, results='asis'}
kable(table2, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Figure 1 - Association between tumour factors and 5 year mortality
`r ''````{r figure1, echo = FALSE, warning=FALSE, message=FALSE, fig.width=10}
colon_s %>% 
or_plot(dependent, explanatory)
```
````

[This is now looking good, and further tweaks can be made if you wish.](https://www.datasurg.net/wp-content/uploads/2018/05/example2.docx)

## PDF via knitr/R Markdown

Default settings for PDF:

```` markdown
---
title: "Example knitr/R Markdown document"
author: "Ewen Harrison"
date: "21/5/2018"
output:
pdf_document: default
---

`r ''````{r setup, include=FALSE}
# Load data into global environment. 
library(finalfit)
library(dplyr)
library(knitr)
load("out.rda")
```

## Table 1 - Demographics
`r ''````{r table1, echo = FALSE, results='asis'}
kable(table1, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Table 2 - Association between tumour factors and 5 year mortality
`r ''````{r table2, echo = FALSE, results='asis'}
kable(table2, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

## Figure 1 - Association between tumour factors and 5 year mortality
`r ''````{r figure1, echo = FALSE}
colon_s %>% 
or_plot(dependent, explanatory)
```
````

[Again, this is not bad, but has issues.](https://www.datasurg.net/wp-content/uploads/2018/05/example.pdf)

We can fix the plot in exactly the same way. But the table is off the side of the page. For this we use the 'kableExtra` package. Install this in the normal manner. You may also want to alter the margins of your page using geometry in the preamble.

```` markdown
---
title: "Example knitr/R Markdown document"
author: "Ewen Harrison"
date: "21/5/2018"
output:
pdf_document: default
geometry: margin=0.75in
---

`r ''````{r setup, include=FALSE}
# Load data into global environment. 
library(finalfit)
library(dplyr)
library(knitr)
library(kableExtra)
load("out.rda")
```

## Table 1 - Demographics
`r ''````{r table1, echo = FALSE, results='asis'}
kable(table1, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"),
booktabs=TRUE)
```

## Table 2 - Association between tumour factors and 5 year mortality
`r ''````{r table2, echo = FALSE, results='asis'}
kable(table2, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"),
booktabs=TRUE) %>% 
kable_styling(font_size=8)
```

## Figure 1 - Association between tumour factors and 5 year mortality
`r ''````{r figure1, echo = FALSE, warning=FALSE, message=FALSE, fig.width=10}
colon_s %>% 
or_plot(dependent, explanatory)
```
````


[This is now looking pretty good for me as well.](https://www.datasurg.net/wp-content/uploads/2018/05/example2.pdf)

There you have it. A pretty quick workflow to get final results into Word and a PDF.
