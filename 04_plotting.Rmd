---
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(tidyverse)
library(gapminder)
# text width is 4.6 inch, but markdown scales down nicely even if we include widths and heights greater than 4.6
knitr::opts_chunk$set(fig.width = 2.8, fig.height = 2.8, cache = TRUE)
```

# Different types of plots

> What I can not create, I do not understand.  
> Richard Feynman


There are a few different plotting packages in R, but the most elegant and versatile one is `ggplot2`^[The name of the package is `ggplot2`, but the function is called `ggplot()`. For everything you've ever wanted to know about the grammar of graphics in R, see @wickham2016 .].
**gg** stands for **g**rammar of **g**raphics which means that we can make a plot by describing it one component at a time. 
In other words, we build a plot by adding layers to it.

This does not have to be many layers, the simplest `ggplot()` consist of just two components:

* the variables to be plotted, 
* a geometrical object (e.g., point, line, bar, box, etc.).

`ggplot()` calls geometrical objects **geoms**.


Figure \@ref(fig:chap04-fig-steps) shows some example steps for building a scatterplot, including changing its appearance ('theme') and faceting - an efficient way of creating separate plots for subgroups.


```{r, message=F, include = FALSE}
library(tidyverse)
library(gapminder)

mydata = gapminder

glimpse(mydata)
mydata$year %>% unique()

gapminder2007 = gapminder %>% 
  filter(year == 2007) %>% 
  mutate(gdpPercap_thousands = gdpPercap/1000)

```


```{r chap04-fig-steps, fig.height=10, fig.width=6, echo = FALSE, fig.cap = "Example steps for building and modiyfing a ggplot. (1) initialising the canvas, defining variables, (2) adding points, (3) colouring points by continent, (4) changing point type, (5) faceting, (6) changing the plot theme and the scale of the x variable."}
library(patchwork)

step1 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp))

step2 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
  geom_point()

step3 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point()   +
  theme(legend.position = "none")

step4 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1)

step5 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~continent)

step5 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~continent)

step6 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap/1000, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~continent) +
  theme_light()

(step1 | step2) / (step3 | step4) / step5 / step6 + plot_annotation(tag_levels = "1", tag_prefix = "(", tag_suffix = ")")

```

\clearpage 

## Data - gapminder

We are using the gapminder dataset (https://www.gapminder.org/data) that has been put into an R package by @bryan2017 so we can load it with `library(gapminder)`.

```{r, message=F, include = TRUE}
library(tidyverse)
library(gapminder)

mydata = gapminder

glimpse(gapminder)
```



The dataset includes `r nrow(gapminder)` observations (rows) of `r ncol(gapminder)` variables (columns: `r colnames(gapminder)`).
`country`, `continent`, and `year` could be though of as grouping variables, whereas lifeExp (life expectancy), pop (population), and gdpPercap (Gross Domestic Product per capita) are values.

The years in this dataset span `r range(gapminder$year) %>% paste(collapse = " to ")` with 5-year intervals (so a total of `r gapminder$year %>% n_distinct()` different years).
It includes `r gapminder$country %>% n_distinct()` countries from `r gapminder$continent %>% n_distinct()` continents (`r gapminder$continent %>% unique()`).

The way for you to double check that all of the numbers we've quoted above are correct, run these lines:

```{r, results = "hide"}
library(tidyverse)
library(gapminder)
gapminder$year %>% unique()
gapminder$country %>% n_distinct()
gapminder$continent %>% unique()
```

Let's create a new shorter tibble called `gapminder2007` that only includes data for the year 2007.

```{r}
gapminder2007 = gapminder %>% 
  filter(year == 2007)

gapminder2007
```


## Anatomy of ggplot explained

We will now explain the six steps shown in Figure \@ref(fig:chap04-fig-steps).
Note that you only need the first two to make a plot, the rest are just to show you further functionality and optional customisations.


**(1)** Start by defining the variables, e.g., `ggplot(aes(x = var1, y = var2))`:

```{r, fig.keep = 'none'}
gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp))
```

This creates the first plot in Figure \@ref(fig:chap04-fig-steps).

Although the above code is equivalent to:

```{r, fig.keep = 'none'}
ggplot(gapminder2007, aes(x = gdpPercap, y = lifeExp))
```

we tend to put the data first and then use the pipe (`%>%`) to send it to the `ggplot()` function.
This becomes useful when we add further data wrangling functions between the data and the `ggplot()`.
For example, our plotting pipelines often look like this:

```{r, fig.keep = 'none', eval = FALSE}
data %>% 
  filter(...) %>% 
  mutate(...) %>% 
  ggplot(aes(...)) +
  ...
```

The lines that come before the `ggplot()` function are piped, whereas from `ggplot()` onwards you have to use +.
This is because we are now adding different layers and customisations to the same plot.

`aes()` stands for **aes**thetics - things we can see. Variables are always inside the `aes()` function, which in return is inside a `ggplot()`.
Take a moment to appreciate the double closing brackets `))` - the first one belongs to `aes()`, the second one to `ggplot()`. 


**(2)** Choose and add a geometrical object

Let's ask `ggplot()` to draw a point for each observation by adding `geom_point()`:

```{r, fig.keep = 'none'}
gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
  geom_point()
```

We have now created the second plot in Figure \@ref(fig:chap04-fig-steps), a scatterplot.

If we copy the above code and change just one thing - the `x` variable from `gdpPercap` to `continent` (which is a categorical variable) - we get what's called a strip plot.
This means we are now plotting a continuous variable (`lifeExp`) against a categorical one (`continent`).
But the thing to note is that the rest of the code stays exactly the same, all we did was change the `x = `.


```{r, fig.width=3}
gapminder2007 %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_point()
```

**(3)** specifying further variables inside `aes()`

Going back to the scatterplot (`lifeExp` vs `gdpPercap`), let's use `continent` to give the points some colour.
We can do this by adding `colour = continent` inside the `aes()`:

```{r, fig.width=4, fig.keep = 'none'}
gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point()
```

This creates the third plot in Figure \@ref(fig:chap04-fig-steps). It uses the default colour scheme and will automatically include a legend.
Still with just two lines of code (`ggplot(...)` + `geom_point()`).

**(4)** specifying aesthetics outside `aes()`

It is very important to understand the difference between including `ggplot` arguments inside or outside of the `aes()` function.

The main aesthetics (things we can see) are: **x**, **y**, **colour**, **fill**, **shape**, **size**, and any of these could appear inside or outside the `aes()` function.
Press F1 on, e.g., `geom_point()`, to see see the full list of aesthetics that can be used with this geom (this opens the Help tab).

Variables  (so columns of your dataset) have to be defined inside `aes()`. Whereas to apply a modification on everything, we can set an aesthetic to constant value outside of `aes()`.

For example, Figure \@ref(fig:chap04-fig-shapes) shows a selection of the point shapes built into R. The default shape used by `geom_point()` is number 16.

```{r chap04-fig-shapes, echo = FALSE, fig.width = 6,  fig.cap="A selection of shapes for plotting. Shapes 0, 1, and 2 are hollow, whereas for shapes 21, 22, and 23 we can define both a colour and a fill (for thes shapes, colour is the border around the fill).", warning = FALSE}

shapes = tibble(shape = c(0, 1, 2, 4, 8, 15, 16, 17, 21, 22, 23), x = 0:10)

ggplot(shapes, aes(x, y = 1)) + 
  geom_text(aes(label = shape), hjust = 0, nudge_x = -0.55) +
  geom_point(aes(shape = shape), size = 5, fill = "#2171b5") +
  scale_shape_identity() +
  theme_void()
```


To make all of the points in our figure hollow, let's set their shape to 1.
We do this by adding `shape = 1` inside the `geom_point()`:

```{r, fig.keep = 'none'}

gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1)

```

This creates the fourth plot in Figure \@ref(fig:chap04-fig-steps).

**(5)** From one plot to multiple with a single extra line

Faceting is a way to efficiently create the same plot for subgroups within the dataset.
For example, we can separate each continent on its own facet by adding `facet_wrap(~continent)` to our plot:


```{r fig.height=3.5, fig.width=7, fig.keep = 'none'}

gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~continent)

```

This creates the fifth plot in Figure \@ref(fig:chap04-fig-steps).
Note that we have to use the tilde (~) in `facet_wrap()`.
There is a similar function called `facet_grid()` that will create a grid of plots based on two grouping variables, e.g, `facet_grid(var1~var2)`.
Furthermore, facets are happy to quickly separate data based on a condition (so something you would usually use in a filter).

```{r, fig.width=6}
gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~pop > 50000000)

```

On this plot, the facet `FALSE` includes countries with a population less than 50 million people, and the facet `TRUE` includes countries with a population greater than 50 million people.

The tilde (~) in R denotes dependency. It is mostly used by statistical models to define dependent and explanatory variables, you will see it a lot in the second part of this book.

**(6)** Grey to white background - changing the theme

Overall, we can customise every single thing on a ggplot.
Font type, colour, size or thickness or any lines or numbers, background, you name it.
But a very quick way to change the appearance of a ggplot is to apply a different theme.
The signature ggplot theme has a light grey background and white grid lines (Figure \@ref(fig:chap04-fig-themes)). 

```{r chap04-fig-themes, echo = FALSE, fig.width=5, fig.height=3.5, fig.cap = "Some of the built-in ggplot themes (1) default (2) theme_bw(), (3) theme_dark(), (4) theme_classic()."}
themeplot = gapminder %>% 
  ggplot(aes(x = year, y = lifeExp)) +
  facet_wrap(~"LABEL")

(themeplot + (themeplot+theme_bw()))/((themeplot + theme_dark()) + (themeplot+theme_classic())) + plot_annotation(tag_levels = "1", tag_prefix = "(", tag_suffix = ")")

```


```{r fig.height=3.5, fig.width=7, fig.keep = 'none'}

step6 = gapminder2007 %>% 
  ggplot(aes(x = gdpPercap/1000, y = lifeExp, colour = continent)) +
  geom_point(shape = 1) +
  facet_wrap(~continent) +
  theme_bw()

```

As a final step, we are adding `theme_bw()` ("background white") to give the plot a different look. 
We have also divided the gdpPercap by 1000 (making the units "thousands of dollars per capita").
Note that you can apply calculations directly on ggplot variables (so how we've done `x = gdpPercap/1000` here).

This creates the last plot in Figure \@ref(fig:chap04-fig-steps).

This is how `ggplot()` works - by adding or modifying things one by one.

\clearpage



## Scatter plots/bubble plots - `geom_point()`

The ggplot anatomy section already covered both scatter and strip plots (both created with `geom_point()`).
One last thing to note about this geom is that adding a size aesthetic makes it into a bubble plot.
For example, let's size the points by population (we're also making them hollow and slightly transparent - `alpha = 0.4` to deal with overplotting):

```{r, fig.width=5}

gapminder2007 %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp, size = pop)) +
  geom_point(shape = 1, alpha = 0.4)
  
```


## Line chart/timeplot - `geom_line()`

Plot life expectancy against year (`x = year, y = lifeExp`), add `geom_line()`:

```{r, fig.width = 4, fig.height=3}
mydata %>% 
  ggplot(aes(x = year, y = lifeExp)) +
  geom_line()
```

The reason you now see this weird zig-zag is that, using the above code, R does not know you want a connected line for each country. 
Specify how you want data points grouped to lines: `group = country` in `aes()`:

```{r, fig.width = 4, fig.height=3}
mydata %>% 
  ggplot(aes(x = year, y = lifeExp, group = country)) +
  geom_line()
```


### Exercise

Follow the step-by-step instructions to transform the grey plot just above into this:


```{r, fig.width=10, echo = FALSE, fig.height=4}

mydata %>% 
  ggplot(  aes(x = year, y = lifeExp, group = country, colour=continent)) +
  geom_line() +
  facet_wrap(~continent) + 
  theme_bw() +
  scale_colour_brewer(palette = "Paired")

```

* Colour lines by continents: `colour=continent` to `aes()`
* *Similarly to what we did in `geom_point()`, you can even size the line thickness by each country's population: `size=pop` to `aes()`*
* Continents on separate panels: `+ facet_wrap(~continent)`
* Make the background white: `+ theme_bw()`
* Use a nicer colour scheme: `+ scale_colour_brewer(palette = "Paired")`


### Advanced example

For European countries only (`filter(continent == "Europe") %>%`), plot life expectancy over time in grey colour for all countries, then add United Kingdom as a red line:


```{r, fig.width=4, fig.height=2}

mydata %>%
  filter(continent == "Europe") %>% #Europe only
  ggplot(aes(x = year, y = lifeExp, group = country)) +
  geom_line(colour = "grey") +
  theme_bw() +
  geom_line(data = filter(mydata, country == "United Kingdom"), colour = "red")


```


### Advanced Exercise

As previous, but add a line for France in blue:

```{r, echo = FALSE, fig.width=4, fig.height=2}

mydata %>%
  filter(continent == "Europe") %>% #Europe only
  ggplot(aes(x = year, y = lifeExp, group = country)) +
  geom_line(colour = "grey") +
  theme_bw() +
  geom_line(data = filter(mydata, country == "United Kingdom"), colour = "red") +
  geom_line(data = filter(mydata, country == "France"),         colour = "blue")


```



## Box-plot - `geom_boxplot()`

Plot the distribution of life expectancies within each continent at year 2007:

* `filter(year == 2007) %>%`
* `x = continent, y = lifeExp`
* `+ geom_boxplot()`

```{r, fig.width=2.75, fig.height=2.75}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_boxplot() +
  theme_bw()

```


### Exercise

Add individual (country) points on top of the box plot:

```{r, echo=F, fig.width=5, fig.height=4}

# optinal labels:
label_data = mydata %>% 
  filter(year == 2007) %>% 
  group_by(continent) %>% 
  filter(lifeExp == max(lifeExp) )


mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_boxplot(outlier.shape = NA) +
  geom_label(data = label_data, aes(label=country), vjust = 0, size = 3) +
  geom_jitter(aes(colour=continent), width=0.3, alpha=0.8) + #width defaults to 0.8 of box width
  theme_bw()


```

Hint: Use `geom_jitter()` instead of `geom_point()` to reduce overlap by spreading the points horizontally. Include the `width=0.3` option to reduce the width of the jitter.

**Optional:**

Include text labels for the highest life expectancy country of each continent.

**Hint 1** Create a separate dataframe called `label_data` with the maximum countries for each continent:
```{r}
label_data = mydata %>% 
  filter(year == max(year)) %>% # same as year == 2007
  group_by(continent) %>% 
  filter(lifeExp == max(lifeExp) )
```

**Hint 2** Add `geom_label()` with appropriate `aes()`:
```{r, eval = FALSE}
+ geom_label(data = label_data, aes(label=country), vjust = 0)
```


### Dot-plot - `geom_dotplot()`

`geom_dotplot(aes(fill=continent), binaxis = 'y', stackdir = 'center', alpha=0.6)`

```{r, echo=F, message=F, fig.width=5, fig.height=4}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_dotplot(aes(fill=continent), binaxis = 'y', stackdir = 'center', alpha=0.6) +
  geom_boxplot(outlier.shape = NA, fill=NA) +
  theme_bw()


```

## Barplot - `geom_bar()` and `geom_col()`


In the first module, we plotted barplots from already summarised data (using the `geom_col`), but `geom_bar()` is perfectly happy to count up data for you. 
For example, we can plot the number of countries in each continent without summarising the data beforehand:

```{r, fig.width=5, fig.height=4}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent)) +
  geom_bar() + 
  ylab("Number of countries") +
  theme_bw()

```


### Exercise

Create this barplot of life expectancies in European countries (year 2007). Hint: `coord_flip()` makes the bars horizontal, `fill = NA` makes them empty, have a look at your QuickStar sheet for different themes.

```{r, fig.width = 4, echo = FALSE}
mydata %>% 
  filter(year == 2007) %>%
  filter(continent == "Europe") %>% 
  ggplot(aes(x = country, y = lifeExp)) +
  geom_col(colour = "#91bfdb", fill = NA) +
  coord_flip() +
  theme_classic()
  
```


## All other types of plots

These are just some of the main ones, see this gallery for more options: http://www.r-graph-gallery.com/portfolio/ggplot2-package/

And the `ggplot()` documentation: http://docs.ggplot2.org/

Remember that you can always combine different types of plots - i.e. add lines or points on bars, etc.


## Specifying `aes()` variables

The `aes()` variables wrapped inside `ggplot()` will be taken into account by all geoms. 
If you put `aes(colour = lifeExp)` inside `geom_point()`, only points will be coloured:

```{r, fig.width = 4, fig.height = 3}

mydata %>% 
  filter(continent == "Europe") %>% 
  ggplot(aes(x = year, y = lifeExp, group = country)) +
  geom_line() +
  geom_point(aes(colour = lifeExp))

```

## Extra: Optional exercises

### Exercise

Make this:


```{r, fig.height=10, fig.width=8}

mydata$dummy = 1  # create a column called "dummy" that includes number 1 for each country

mydata2007 = mydata %>% 
  filter(year==max(year)) %>% 
  group_by(continent) %>% 
  mutate(country_number = cumsum(dummy))  # create a column called "country_number" that
  # is a cumulative sum of the number of countries before it - basically indexing


mydata2007 %>% 
  ggplot(aes(x = continent)) +
  geom_bar(aes(colour=continent), fill = NA) +
  geom_text(aes(y = country_number, label=country), size=4, vjust=1, colour='black')+
  theme_void()

```

\newpage

### Exercise

Make this:

Hints: `coord_flip()`, `scale_color_gradient(...)`, `geom_segment(...)`, `annotate("text", ...)`

```{r, fig.width=7, fig.height=5}

mydata %>% 
  filter(continent == "Europe") %>% 
  ggplot(aes(y = fct_reorder(country, gdpPercap, .fun=max), x=lifeExp, colour=year)) +
  geom_point(shape = 15, size = 2) +
  theme_bw() +
  scale_colour_distiller(palette = "Greens", direction = 1) +
  geom_segment(aes(yend = "Switzerland", x = 85, y = "Bosnia and Herzegovina", xend = 85),
               colour = "black", size=1,
               arrow = arrow(length = unit(0.3, "cm"))) +
  annotate("text", y = "Greece", x=83, label = "Higher GDP per capita", angle = 90)

```




## Solutions

**4.2.1**

```{r, eval = FALSE, fig.width=6}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(  aes(x = gdpPercap/1000, #divide by 1000 to tidy the x-axis
               y = lifeExp,
               colour=continent,
               size=pop)) +
  geom_point(shape = 1) +
  facet_wrap(~continent) +
  theme_bw()

```

**4.3.1**

```{r, fig.width=10, eval = FALSE, fig.height=4}

mydata %>% 
  ggplot(  aes(x = year, y = lifeExp, group = country, colour=continent)) +
  geom_line() +
  facet_wrap(~continent) + 
  theme_bw() +
  scale_colour_brewer(palette = "Paired")

```

**which**

Add ` + 
geom_line(data = filter(mydata, country == "France"), colour = "blue")`

**4.4.1**

```{r, eval=F, fig.width=5, fig.height=4}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(colour=continent), width=0.3, alpha=0.8) + #width defaults to 0.8 of box width
  theme_bw()


```


```{r, eval = FALSE}

mydata %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = continent, y = lifeExp)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(colour=continent), width=0.3, alpha=0.8)
  theme_bw()


```

**4.5.1**

```{r, fig.width = 4, eval = FALSE}
mydata %>% 
  filter(year == 2007) %>%
  filter(continent == "Europe") %>% 
  ggplot(aes(x = country, y = lifeExp)) +
  geom_col(colour = "#91bfdb", fill = NA) +
  coord_flip() +
  theme_classic()
  
```

